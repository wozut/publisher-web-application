#!/bin/bash

# Pre-push hook that runs quality checks only when pushing to main branch

protected_branch='main'
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Only run checks if pushing to main branch
if [ "$current_branch" = "$protected_branch" ]; then
    echo "ğŸ” Running pre-push checks for main branch..."
    
    # Run build
    echo "ğŸ”¨ Building application..."
    if ! npm run build; then
        echo "âŒ Build failed. Please fix build errors before pushing."
        exit 1
    fi
    echo "âœ… Build successful"
    
#    # Run database migrations
#    echo "ğŸ—„ï¸  Running database migrations..."
#    if ! npx prisma migrate deploy; then
#        echo "âŒ Database migration failed. Please check your migrations."
#        exit 1
#    fi
#    echo "âœ… Database migrations successful"
    
    # Run tests
    echo "ğŸ§ª Running tests..."
    if ! npm run test; then
        echo "âŒ Tests failed. Please fix failing tests before pushing."
        exit 1
    fi
    echo "âœ… All tests passed"

#    # Run format check
#    echo "ğŸ“‹ Checking code formatting..."
#    if ! npm run format:check; then
#        echo "âŒ Code formatting check failed. Run 'npm run format' to fix."
#        exit 1
#    fi
#    echo "âœ… Code formatting check passed"
    
    echo "ğŸ‰ All pre-push checks passed! Push to main allowed."
else
    echo "â„¹ï¸  Skipping pre-push checks (not pushing to main branch)"
fi